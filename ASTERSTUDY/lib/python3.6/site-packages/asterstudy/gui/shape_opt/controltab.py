from .crontrol_ui import Ui_Form
from PyQt5 import Qt as Q
from ...common import load_icon

class Maincontrol(Q.QWidget):
    def __init__(self,qianchuli):
        super(Maincontrol,self).__init__()
        self.ui = Ui_Form()
        self.ui.setupUi(self)
        # 给按钮添加图标
        self.add_icon()

        # QProcess object for external app
        self.process = Q.QProcess(self)
        self.process.readyRead.connect(self.dataReady)
        # self.process.started.connect(lambda: self.bt1.setEnabled(False))
        # self.process.finished.connect(lambda: self.bt1.setEnabled(True))
        self.process.setProcessChannelMode(Q.QProcess.MergedChannels)

        self.ui.pushButton_2.clicked.connect(self.start_fem)
        self.ui.pushButton.clicked.connect(self.kill_fem)
    
    def add_icon(self):
        self.ui.pushButton_2.setIcon(load_icon('startdefault.png'))
        self.ui.pushButton_3.setIcon(load_icon('startdefault.png'))
        self.ui.pushButton.setIcon(load_icon('halt.png'))
        self.ui.pushButton_4.setIcon(load_icon('halt.png'))

    def dataReady(self):
        #self.keyboardWidget = KeyboardWidget()
        self.simulationOutput = self.ui.textBrowser.textCursor()
        processStdout = bytearray(self.process.readAllStandardOutput())
        processStdout = processStdout.decode(encoding='UTF-8',errors='strict')
        newCursor1 = self.ui.textBrowser.textCursor()
        newCursor1.movePosition(Q.QTextCursor.End)
        self.ui.textBrowser.setTextCursor(newCursor1)
        self.simulationOutput = self.ui.textBrowser.textCursor()
        self.simulationOutput.insertText(processStdout)

    def start_fem(self):
        cmd = 'sh /share/simforge_home/nsccwx/xyg/calculix/beam/test.sh'
        self.process.start(cmd)
    
    def kill_fem(self):
        self.process.kill()
        self.simulationOutput.insertText("——————计算被手动终止！——————" + "\n")
        
